## План реализации клиентской части: i18n — инкрементальные обновления

1. Ввести опции версионирования в `createI18n`
   - Добавить опции: `initialVersion?`, `getCurrentVersion?`, `getPatch?`, `onVersionChange?`, `versionStore?`, `autoSyncOnInit?` (по умолчанию false), `autoSyncOnSetLang?` (по умолчанию true).
   - Обновить возвращаемый API: `getVersion(): number`, `sync(): Promise<void>`.
   - Обеспечить обратную совместимость: все новые опции опциональны, поведение без них не меняется.

2. Реализовать хранение версии активного языка
   - Ввести внутреннее состояние `versionState` (через `adapter.state<number>`), инициализируемое из `initialVersion` или `versionStore.get(lang)` (если доступно), иначе 0.
   - На первом этапе хранить версию только для активного языка (без мульти-языкового кэша версий).

3. Реализовать `versionStore` по умолчанию на куках `lasti18n`
   - Добавить небольшие утилиты: `parseLastI18nCookie(value: string): { lang: string; version: number } | null`, `formatLastI18nCookie(lang: string, version: number): string`.
   - Поведение по умолчанию: при изменении версии вызывать `document.cookie = ...` (в браузере); в SSR — no-op.
   - Разрешить переопределение через опцию `versionStore`.

4. Интегрировать версию в жизненный цикл инициализации
   - При создании i18n: считать `versionState` из опций/куки.
   - Если `autoSyncOnInit` и задан `getPatch` (и/или `getCurrentVersion`), инициировать `sync()`.

5. Реализовать `sync()`
   - Получить `v_local = versionState.get()` и текущий `lang`.
   - Если задан `getCurrentVersion`, получить `v_server` и выйти без сетевых запросов при `v_server === v_local`.
   - Запросить патч через `getPatch(lang, v_local)`; проверить: `patch.from === v_local`, `patch.to >= patch.from`.
   - Применить `patch.data` к внутреннему стору только для языка `lang` (добавление/перезапись значений).
   - Обновить `versionState` до `patch.to`; сохранить через `versionStore.set(lang, patch.to)`; вызвать `onVersionChange?.(lang, patch.to)`.
   - Инвалидировать кэш форматированных строк для этого языка.

6. Изменить стратегию кэширования форматированных строк
   - Ввести функцию `invalidateCacheForLang(lang)`, удаляющую записи этого языка из LRU (по префиксу `${lang}|`).
   - Сохранить лимит кэша и поведение LRU неизменными.

7. Интегрировать синхронизацию в `setLang`
   - После `setLang(next)` и `ensureLangLoaded(next)` обновить `versionState` из `versionStore.get(next)` (если доступно).
   - Если `autoSyncOnSetLang` и доступен `getPatch`/`getCurrentVersion`, вызвать `sync()`.
   - Не запускать синхронизацию, если приложение известно перезагружает страницу при смене языка (оставить это на усмотрение интегратора через опцию `autoSyncOnSetLang`).

8. Обработка ошибок и рассинхронизации
   - Несогласованный патч (`patch.from !== v_local`): не применять изменения, при наличии `getCurrentVersion` — пересверить версию и повторить один раз; иначе — отложить до следующего вызова `sync()`.
   - Сетевые ошибки: не изменять стор; выставить `errorState`; ретраи оставлять на интегратора.
   - Пустой патч (`from == to` или `data = {}`): ничего не менять, можно лишь обновить куку.

9. SSR и гидратация (клиентская часть)
   - Поддержать `initialVersion` из SSR (или из встроенных данных); при гидратации не выполнять запросов, если версии совпадают.
   - В отсутствие `getCurrentVersion` допускать немедленный `getPatch(lang, v_local)` (сервер может вернуть 204 или пустые данные).

10. Документация разработчика

- Обновить `docs/modules/i18n.md` и README: описать новые опции, пример интеграции с `getPatch`, работу с кукой.
- Добавить раздел «Как включить авто‑синк» и «Как протестировать локально».

11. Тестирование (WTR)

- Добавить новые тесты в `tools/tests/i18n/*`, переиспользуя фикстуры:
  - `i18n.versioning.sync.test.ts`: применение патча `10→12`, проверка `getVersion() === 12`, строки доступны.
  - `i18n.versioning.empty-patch.test.ts`: пустой патч, отсутствие изменений.
  - `i18n.versioning.mismatch.test.ts`: `from !== v_local`, стор не меняется, ошибка фиксируется.
  - `i18n.versioning.cache-invalidate.test.ts`: после патча кэш форматированных строк инвалидирован для языка.
  - `i18n.versioning.setLang.test.ts`: чтение версии из `versionStore` и авто‑синк при смене языка.
  - `i18n.versioning.ssr.test.ts`: `initialVersion` совпадает — синхронизация не выполняется.
  - `i18n.versioning.onVersionChange.test.ts`: вызов колбэка и запись куки.

12. Регрессия и совместимость

- Прогнать существующие тесты i18n: отсутствие изменений поведения без новых опций.
- Проверить отсутствие IIFE в шаблонных литералах `lit-html`, отсутствие `import()` аннотаций типов.

13. Готовность к релизу

- Обновить TypeDoc описания публичного API.
- Добавить раздел в `docs/migration/README.md` c инструкциями по подключению синхронизации (опционально).
